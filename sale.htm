<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sale of Tender Form</title>

  <!-- Choices.js -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; background: #2b2b2b; color: #eee; margin: 0; padding: 20px; }
    h2 { color: #fff; display: inline-block; margin: 0; }

    .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .summary-stamp {
      background: #003366;
      color: #fff;
      border-radius: 8px;
      padding: 10px 18px;
      font-size: 14px;
      font-weight: bold;
      line-height: 1.5;
      text-align: right;
      box-shadow: 0 0 8px rgba(0,0,0,0.3);
      min-width: 90px;   /* adjust width here */
    }

    .toolbar { margin-bottom: 15px; display: flex; gap: 10px; justify-content: space-between; align-items: center; }
    .toolbar input { padding: 6px; border-radius: 4px; border: 1px solid #555; width: 360px; font-size: 13px; }
    .toolbar button { padding: 6px 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; }
    .toolbar button:hover { background: #218838; }

    table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 13px; background: #333; }
    th, td { border: 1px solid #555; padding: 6px; text-align: center; vertical-align: top; }
    thead { background: #003366; color: #fff; position: sticky; top: 0; z-index: 2; }

    /* Vendor Styling */
    .vendor-list { max-height: 100px; overflow-y: auto; text-align: left; padding-right: 6px; }
    .vendor-tag { display: block; background: green; color: #fff; font-weight: bold; border-radius: 4px; padding: 2px 6px; margin: 2px 0; font-size: 11px; text-align: left; }
    .vendor-count { font-size: 11px; color: #ffcc00; margin-top: 4px; display: block; text-align: right; }

    #dataTable th:nth-child(14),
    #dataTable td:nth-child(14) {
      width: 150px;
      max-width: 150px;
    }

    #message { margin: 10px 0; padding: 8px; display: none; border-radius: 4px; font-size: 13px; text-align: center; }
    #message.success { background: #28a745; color: #fff; }
    #message.error { background: #dc3545; color: #fff; }

    button.action-btn { padding: 6px 14px; border: none; border-radius: 6px; color: #fff; cursor: pointer; font-size: 13px; font-weight: bold; }
    .btn-save { background: green; }
    .btn-update { background: orange; }

    /* Popup */
    #progressPopup { display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
      background:rgba(0,0,0,0.3); z-index:9999; align-items:center; justify-content:center; }
    #progressPopup div { background:#28a745; color:#fff; padding:20px 30px; border-radius:12px; 
      box-shadow:0 2px 10px rgba(0,0,0,0.25); font-size:15px; font-weight:500; text-align:center; }
  </style>
</head>
<body>
  <div class="header-bar">
    <h2>Sale of Tender Form</h2>
    <div class="summary-stamp" id="summaryStamp">
      Total NIT = 0<br>
      Total Schemes = 0
    </div>
  </div>

  <div id="message"></div>
  <div id="progressPopup"><div><span id="progressMessage">Processing...</span></div></div>

  <div class="toolbar">
    <input id="searchInput" type="text" placeholder="üîç Search..." oninput="filterTable()" />
    <div style="display:flex; gap:8px;">
      <button id="refreshBtn" onclick="refreshData()">‚ü≥ Refresh</button>
      <button id="clearSearchBtn" onclick="clearSearch()">‚úñ Clear</button>
    </div>
  </div>

  <table id="dataTable">
    <thead>
      <tr>
        <th>Timestamp</th>
        <th>Financial Year</th>
        <th>UNIQUE NIT</th>
        <th>NIT No</th>
        <th>Date</th>
        <th>Sl No.</th>
        <th>Activity ID</th>
        <th>Name of the work</th>
        <th>Site details</th>
        <th>Source of Fund</th>
        <th>Tendered Amount (In Rs.)</th>
        <th>Tender Form Price</th>
        <th>Earnest Money</th>
        <th>Vendors</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbxgOwETYg5roDTEnBqy8qQGnC-FNzx2iOz5qYVZE5TySfDHmmEb_uEx2DL4c4GKbNEwMQ/exec"; 
    let tableData = [];
    let vendorOptions = [];

    function valueToString(v){ if(v===null||v===undefined) return ""; return String(v); }

    async function refreshData(){ await loadData(); }

    async function loadData(){
      const [vRes,tRes] = await Promise.all([
        fetch(scriptURL+"?action=getVendors"),
        fetch(scriptURL+"?action=getTenderData")
      ]);
      vendorOptions = await vRes.json();
      tableData = await tRes.json();
      renderTable(tableData);
      updateSummary(tableData);
    }

    function updateSummary(data){
      const totalSchemes = data.length;
      const uniqueNITs = new Set(data.map(r => valueToString(r[4]).trim()).filter(Boolean)).size;
      document.getElementById("summaryStamp").innerHTML =
        `Total NIT = ${uniqueNITs}<br>Total Schemes = ${totalSchemes}`;
    }

    function renderTable(data){
      const tbody=document.querySelector("#dataTable tbody");
      tbody.innerHTML="";
      data.forEach((row,idx)=>{
        const tr=document.createElement("tr");
        const timeStamp=valueToString(row[0]),
              finYear=valueToString(row[1]),
              nitNo=valueToString(row[4]),
              nitDate=valueToString(row[5]),
              slNo=valueToString(row[6]),
              uniqueNIT=valueToString(row[7]),
              activityId=valueToString(row[8]),
              workName=valueToString(row[9]),
              siteDetails=valueToString(row[10]),
              fund=valueToString(row[11]),
              tenderAmt=valueToString(row[12]),
              formPrice=valueToString(row[13]),
              earnest=valueToString(row[14]),
              vendorsArr=valueToString(row[15]).split(",").map(s=>s.trim()).filter(s=>s);

        [timeStamp,finYear,uniqueNIT,nitNo,nitDate,slNo,activityId,workName,siteDetails,fund,tenderAmt,formPrice,earnest].forEach(val=>{
          const td=document.createElement("td"); td.textContent=val; tr.appendChild(td);
        });

        const tdVendor=document.createElement("td");
        if(vendorsArr.length>0){
          const container=document.createElement("div"); container.className="vendor-list";
          vendorsArr.forEach(v=>{
            const span=document.createElement("span");
            span.className="vendor-tag"; span.textContent=v;
            container.appendChild(span);
          });
          const countSpan=document.createElement("span");
          countSpan.className="vendor-count";
          countSpan.textContent="Count: "+vendorsArr.length;
          container.appendChild(countSpan);
          tdVendor.appendChild(container);
        } else {
          tdVendor.textContent = "‚Äî";
        }
        tr.appendChild(tdVendor);

        const tdAction=document.createElement("td");
        const btn=document.createElement("button");
        btn.textContent="Save"; btn.classList.add("action-btn","btn-save");
        tdAction.appendChild(btn);
        tr.appendChild(tdAction);

        tbody.appendChild(tr);
      });
    }

    function filterTable(){
      const q=(document.getElementById("searchInput").value||"").trim().toLowerCase();
      if(!q){ renderTable(tableData); updateSummary(tableData); return; }
      const filtered=tableData.filter(row=>{
        const nitNo=valueToString(row[4]).toLowerCase(),
              date=valueToString(row[5]).toLowerCase(),
              slNo=valueToString(row[6]).toLowerCase(),
              activityId=valueToString(row[8]).toLowerCase(),
              workName=valueToString(row[9]).toLowerCase(),
              siteDetails=valueToString(row[10]).toLowerCase(),
              fund=valueToString(row[11]).toLowerCase(),
              uniqueNIT=valueToString(row[7]).toLowerCase();
        return (uniqueNIT.includes(q) || nitNo.includes(q) || date.includes(q) ||
                activityId.includes(q) || workName.includes(q) ||
                siteDetails.includes(q) || fund.includes(q));
      });
      renderTable(filtered);
      updateSummary(filtered);
    }

    function clearSearch(){
      document.getElementById("searchInput").value="";
      renderTable(tableData);
      updateSummary(tableData);
    }

    loadData();
  </script>
</body>
</html>
